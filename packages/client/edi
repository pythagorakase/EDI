#!/usr/bin/env python3
"""
EDI Communication CLI

Sends messages to the EDI agent (Clawdbot) via the Thread Server HTTP API.
EDI is an autonomous agent that can help with testing and other tasks.

Usage:
    edi "Hello, EDI!"
    edi "Please run the live tests for the wizard agent"
    echo "message" | edi

Thread Management:
    edi "message"                    # Auto-continue last thread (or start new)
    edi --new "message"              # Force new thread
    edi --thread abc123 "message"    # Continue specific thread
    edi --show-thread "message"      # Display thread ID with response
"""

import argparse
import sys
from pathlib import Path
from typing import Optional, Tuple

import requests

EDI_ENDPOINT = "http://100.104.206.23:19001/ask"
THREAD_FILE = Path.home() / ".edi-thread"


def save_thread(thread_id: str) -> None:
    """Save thread ID for auto-continuation."""
    THREAD_FILE.write_text(thread_id)


def load_thread() -> Optional[str]:
    """Load saved thread ID, if any."""
    if THREAD_FILE.exists():
        return THREAD_FILE.read_text().strip() or None
    return None


def clear_thread() -> None:
    """Clear saved thread ID."""
    THREAD_FILE.unlink(missing_ok=True)


def send_to_edi(message: str, thread_id: Optional[str] = None) -> Tuple[str, Optional[str]]:
    """Send a message to EDI and return (reply, thread_id)."""
    payload = {
        "message": message,
        "threadId": thread_id,
        "timeoutSeconds": 120,
    }

    response = requests.post(EDI_ENDPOINT, json=payload, timeout=130)
    response.raise_for_status()
    data = response.json()

    if data.get("ok"):
        return data["reply"], data.get("threadId")
    else:
        raise RuntimeError(data.get("error", "Unknown error from EDI"))


def main():
    parser = argparse.ArgumentParser(
        description="Send messages to EDI (Clawdbot autonomous agent)",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog=__doc__,
    )
    parser.add_argument(
        "message",
        nargs="*",
        help="Message to send to EDI (can also be piped via stdin)",
    )
    parser.add_argument(
        "--thread", "-t",
        metavar="ID",
        help="Continue existing thread by ID",
    )
    parser.add_argument(
        "--new", "-n",
        action="store_true",
        help="Force new thread (clears saved thread)",
    )
    parser.add_argument(
        "--show-thread",
        action="store_true",
        help="Display thread ID with response",
    )

    args = parser.parse_args()

    # Get message from args or stdin
    if args.message:
        message = " ".join(args.message)
    elif not sys.stdin.isatty():
        message = sys.stdin.read().strip()
    else:
        print("Error: No message provided. Use: edi 'your message' or echo 'message' | edi")
        sys.exit(1)

    if not message:
        print("Error: Empty message")
        sys.exit(1)

    # Determine thread ID to use
    if args.new:
        clear_thread()
        thread_id = None
    elif args.thread:
        thread_id = args.thread
    else:
        # Auto-continue: use saved thread if available
        thread_id = load_thread()

    # Send to EDI
    try:
        reply, new_thread_id = send_to_edi(message, thread_id)

        # Save thread for auto-continuation
        if new_thread_id:
            save_thread(new_thread_id)

        # Output
        if args.show_thread and new_thread_id:
            print(f"[Thread: {new_thread_id}]")
        print(reply)

    except requests.exceptions.ConnectionError:
        print("Error: Cannot reach EDI Thread Server.", file=sys.stderr)
        print("Is Tailscale running? Check the menu bar icon or run: open /Applications/Tailscale.app", file=sys.stderr)
        sys.exit(1)
    except requests.exceptions.RequestException as e:
        print(f"Error communicating with EDI: {e}", file=sys.stderr)
        sys.exit(1)
    except RuntimeError as e:
        print(f"EDI error: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
